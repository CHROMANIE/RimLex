AutoUITranslator ユーザーガイド v1
===================================

【目的】
画面に表示された英語を自動収集し、自然な日本語UIを辞書で再現する。
API不要・完全オフライン動作・Per-Mod収集＋全体集約に対応。

-----------------------------------
【フォルダ構造と役割】
-----------------------------------
Mods/AutoUITranslator/
├─ Dict/ ................ 翻訳辞書（strings_ja.tsv）
├─ Export/ .............. 収集データ（Per-Mod / _All）
├─ Build/ ............... DLL出力先
├─ Source/ .............. ソースコード
├─ AutoUITranslator.log . 動作ログ
├─ AutoUITranslator.ini . 設定ファイル
└─ その他 ............... RimWorldが自動生成する作業ファイル

-----------------------------------
【Export フォルダの詳細】
-----------------------------------
1) Export/<Mod名>/…（Per-Mod 出力）
  誰が書く？ → UIフック → TranslatorHub.TranslateOrEnroll() → Enroll()
  いつ？ → 画面に文字列が“表示される瞬間”（辞書に未訳だった場合）

  texts_en.txt
    そのModで見つけた生の英語を1行ずつ追記。同セッション内では重複抑制。
    例）Enable anal drip graphics

  strings_en.tsv
    同じ内容を表形式で。1行に timestamp_utc, mod, source, scope, text。
    タブ区切り・ヘッダ付き。辞書化時の参照に便利。

  使いどころ：どのMODのどのUIフックから来た英語かを原因追跡したい時。

2) Export/_All/…（集約）
  誰が書く？
    軽量追記：TranslateOrEnroll() → TryEnsureAggregateLazy()
    再構築：メニュー「整理（MOD別/集約）」「未訳一覧」→ RebuildAggregateAndUntranslated()

  texts_en_aggregate.txt
    全Modの texts_en.txt を重複排除＋ソートして作り直した総集編。
    整理ボタンで正規の最新版にリビルド。

  untranslated.txt
    _All/texts_en_aggregate.txt のうち、辞書に未登録の行だけを抽出。次の翻訳候補。

  strings_en_aggregate.tsv
    untranslated.txt をTSV化（text列のみ）。ExcelやGPTへの入力向け。

  grouped_by_mod.txt
    各Modごとに「### ModName」ブロックで整形。レビュー・共有に便利。

  使いどころ：翻訳担当はここだけ見ればOK。untranslated.txtをGPTに渡し辞書TSVを作るのが最短。

3) Export/Current/…（Per-Mod無効時の一時置き場）
  Config.ExportPerMod=false の場合に使用。すべてここに出力。

4) Export/SelfTest/…（自己テスト）
  設定画面の「動作確認：テスト行を書き出す」を押したときに生成。
  ファイル出力や文字化けの確認用。

-----------------------------------
【ログファイル】
-----------------------------------
AutoUITranslator.log
  本MODの動作ログ。初期化・収集件数・集約・リセットなどを記録。
  トラブルシュート時はまずここを確認。

Player.log（RimWorld標準）
  Harmonyのパッチ競合や例外の詳細。「method not found」などはここに出る。

-----------------------------------
【処理の流れ】
-----------------------------------
1. UIに英語が表示される
    → UIフック（Label/Button/Slider/Tooltip/FloatMenu/Gizmo）が捕捉
    → TranslatorHub.TranslateOrEnroll(text, source, scope)

2. 辞書ヒット？
    ヒットした：置換カウント+1、日本語で表示（ApplyDictAtRuntimeがON時）
    未訳：
      ・Export/<Mod名>/texts_en.txt に追記（同セッション重複抑制）
      ・Export/<Mod名>/strings_en.tsv に追記（ヘッダ付き）
      ・_All/texts_en_aggregate.txt に初回のみ軽量追記

3. メニュー操作
    「整理（MOD別/集約）」または「未訳一覧」→ 全Per-Modファイルから再集計して _All/* 再生成
    「収集をリセット」→ Exportを削除し再作成（セッションキャッシュも初期化）
    「ログをクリア」→ AutoUITranslator.log を空に

-----------------------------------
【よくある質問】
-----------------------------------
Q. _All/texts_en_aggregate.txt がリセット後に残っている／すぐできるのはなぜ？
A. UI操作で軽量追記が再び動いたため。リセット直後に触らなければ空のまま。

Q. 「Allow Tool」「Show info messages」など不要な文言が混ざる
A. 開発者モードのログ画面(EditWindow_Log)やMOD一覧(Page_ModsConfig)を収集対象外に設定済。
   それ以外の画面で混入する場合は除外リストを追加。

Q. 何を消せば完全初期化？
A. 「収集をリセット」でExportを空に。辞書も白紙にするならDict/strings_ja.tsvを手動削除または退避。

-----------------------------------
【使い分けの指針】
-----------------------------------
翻訳作業：Export/_All/untranslated.txt → GPTで翻訳 → Dict/strings_ja.tsv
原因追跡：Export/<Mod名>/strings_en.tsv（source/scopeで追跡）
ノイズ確認：_All/texts_en_aggregate.txt（短文・定型語が多ければNoiseFilter強化）

-----------------------------------
【翻訳ワークフロー】
-----------------------------------
1. ゲームでUIを触って英文収集。
2. Export/_All/untranslated.txt をGPTに渡して自然な日本語訳を作る。
3. Dict/strings_ja.tsv に追記。
4. 「辞書を再読み込み」で即時反映。
