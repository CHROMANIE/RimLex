RimLex ソース一式＋運用メモ v3
作成: 2025-10-07 13:00 (JST) / バージョン: 0.9.0（MVP）

============================================================
■ フォルダ構成（推奨）
============================================================
<ModRoot>/
  ├─ About/                    … 配布メタ
  │   └─ About.xml
  ├─ Assemblies/
  │   └─ RimLex.dll            … ビルド成果
  ├─ Dict/
  │   └─ strings_ja.tsv        … 「英語<TAB>日本語」
  ├─ Export/                   … 実行時生成（PerMod/_All/Current/SelfTest）
  ├─ Source/                   … ソース一式
  │   ├─ RimLex.csproj
  │   ├─ Config.cs
  │   ├─ Normalizer.cs
  │   ├─ NoiseFilter.cs
  │   ├─ TranslatorHub.cs
  │   ├─ UIPatches.cs
  │   └─ ModInitializer.cs
  └─ RimLex.ini

============================================================
■ RimLex.csproj（要点）
============================================================
- .NET Framework v4.7.2 / OutputType=Library / Assemblies 直下へ出力
- 参照: Assembly-CSharp.dll, UnityEngine.CoreModule.dll, UnityEngine.IMGUIModule.dll, 0Harmony.dll
- Compile: Config.cs / Normalizer.cs / NoiseFilter.cs / TranslatorHub.cs / UIPatches.cs / ModInitializer.cs

============================================================
■ 各ファイルの責務と主要API
============================================================
[Config.cs]
- INI の読み書き。%ModDir% 変数を解決、相対↔絶対 変換。
- キー: ApplyDictAtRuntime / ExportPerMod / EmitAggregate / ExportMode / DictPath / LogPath / ExportRoot / PerModSubdir / MinLength / ExcludePatterns

[Normalizer.cs]
- Normalize(string s): RichTextタグ/制御文字を除去し、改行→空白、空白縮約、Trim。

[NoiseFilter.cs]
- Init(Config) / IsNoise(string):
  - MinLength と ExcludePatterns（パイプ区切り）で除外。
  - 例: 空白行 / URL / 数字のみ / GUID 体裁 等

[TranslatorHub.cs]
- InitIO(dictPath, exportRoot, exportMode, exportPerMod, emitAggregate, logInfo, logWarn, perModSubdir)
- ReloadDictionary(): TSVを「英語→日本語」で辞書化。
- TranslateOrEnroll(text, source, scope): 置換 or 収集。
  - **翻訳済みテキストは再収集しない**（ヒット時は Replaced++ のみ）
  - 未訳のみ Enroll（スマートフィルタ）
- Enroll(en, source, scope): Per-Mod texts_en.txt / strings_en.tsv 追記、_All へ軽量追記
- TryEnsureAggregateLazy(en): セッション内重複を抑制
- RebuildAggregateAndUntranslated(out aggCount, out untransCount, out modSections):
  - _All/ texts_en_aggregate.txt / untranslated.txt / strings_en_aggregate.tsv / grouped_by_mod.txt を**正規再構築**
- TryResetExport(out error): Export を丸ごと再作成
- ClearSessionCaches(out perMod, out aggregate): 二重書込防止キャッシュを初期化
- GetAndResetSessionStats(out replaced, out collected, out ioErrors): セッション統計を取得/初期化
- ResolveCallingModName(): StackTrace から /Mods/<ModName>/ を抽出（迷子時は RimWorld）

[UIPatches.cs]
- Apply(Harmony, logInfo, logWarn, applyAtRuntime)
  - 「ゆるい署名探索」で各オーバーロードに前置/後置パッチ
- フック:
  - Widgets.Label(Rect,string) → prefix（ref string label）
  - Listing_Standard.Label(第1引数stringの全Overload) → prefix（ref string __0）
  - Widgets.ButtonText(Rect,string, …) → prefix（ref string __1）
  - TooltipHandler.TipRegion(Rect,string) [全Overload] → prefix（ref string text）
  - TooltipHandler.TipRegion(Rect,TipSignal) → prefix（ref TipSignal tip）
  - FloatMenuOption::.ctor(string,Action, …) → prefix（ref string label）
  - Command.LabelCap.get → postfix（ref string __result）
  - Listing_Standard.Slider(float,float,float) → prefix（存在確認のみ）
- 例外は握り潰し。他のパッチ適用は継続。

[ModInitializer.cs]
- Mod エントリ。RimLex.ini を読み込み、ログ初期化、TranslatorHub.InitIO、Harmony適用、設定UI描画。
- 設定UI:
  - トグル: ApplyDictAtRuntime / ExportPerMod / EmitAggregate / ExportMode / PerModSubdir
  - 生成: 未訳一覧 / 整理（MOD別/集約） / フォルダを開く（_All/PerMod/Export）
  - リセット: 収集リセット / セッションキャッシュ / ログクリア
  - ユーティリティ: 辞書再読込 / 動作確認（SelfTest）
  - すべてに Mouseover 説明＋完了トースト（件数）

============================================================
■ 実装の要点
============================================================
- 「翻訳済みテキストは再収集しないスマートフィルタ」：辞書ヒット時は収集せず即Return。
- Per-Mod 仕分け：StackTrace→ Assembly.Location の /Mods/<ModName>/ を抽出。
- _All の軽量追記：セッション内 HashSet で二重抑止、正式版は「整理」で再構築。
- 文字コード：UTF-8（BOMなし）。TSV は 1行目にヘッダ固定。

============================================================
■ ビルド手順（要点）
============================================================
- 参照DLLの HintPath を環境に合わせる（RimWorldWin64_Data/Managed/… / Mods/Harmony/…）
- Release ビルド → Assemblies/RimLex.dll を配置
- About.xml の <name> と <modClass> は RimLex に統一

============================================================
■ 変更履歴（ダイジェスト）
============================================================
- v2 → v3（本書）
  - AutoUITranslator → RimLex に改称（命名・ログ・ini・UIを統一）
  - TooltipHandler.TipRegion（string/TipSignal）を実装、マウスオーバー収集を安定化
  - フック探索を “ゆるい署名判定” ＋ try保護に刷新
  - PerModSubdir 追加（Per-Modを1段フォルダへ集約）
  - 設定UIに Mouseover 説明・完了トースト・「フォルダを開く」を追加
  - INI に MinLength / ExcludePatterns を追加
  - Slider 署名差異を安全化
- 既知の課題（次版で対処）
  - 画面単位の除外（EditWindow_Log / Page_ModsConfig 等）
  - Command の説明文収集、HUD カウンタ
  - _All 再構築ヘッダと初期スロットル
-- END OF SOURCE ARCHIVE --
