AutoUITranslator 機能仕様書（Functional Spec） v2
=================================================
作成日: 2025-10-05 (JST)
想定対象: RimWorld 1.5+ / .NET Framework 4.7.2–4.8 / Harmony 2.x
目的: ソースを失っても、この仕様だけで同等のMODを再実装できること

0) 目的と思想
-------------
- 目的: RimWorld の「画面に表示される英語」を収集し、手動辞書で“即時”に日本語へ置換する。
- キー思想:
  1. UI描画レイヤーでのリアルタイム置換（ApplyDictAtRuntime）
  2. 未訳テキストの自動収集（ノイズ除去つき）
  3. 収集段階での“MODごと”整理（Per‑Mod 出力 + 集約版）
  4. 運用UI（Mod設定パネル）からワンボタンで「辞書再読込／整理／（任意）UTF出力」
  5. 将来的なUTF連携（caller情報に基づくXML自動生成）は“拡張”として外付け

1) スコープ（対応範囲）
----------------------
- 翻訳対象: 「画面に描画される文字列」
  - Widgets.Label, Listing_Standard.Label, TooltipHandler.TipRegion, Widgets.ButtonText
  - 追加対応: Widgets.HorizontalSlider / FloatRange / Listing_Standard.Slider（補助ラベル）
  - 追加対応: 右クリックメニュー（FloatMenuOption）、ギズモ（Command_* label/desc）、ダイアログボタン（Dialog_*）
  - 追加対応: GUI.Label 直呼び（フォールバック）
- 非対象（デフォルト）: バックエンドログ/例外文・非UI文字列（必要なら別拡張）

2) 非機能要件
------------
- 高速: 置換はハッシュ辞書ルックアップ（O(1)）で、体感遅延ゼロ
- 安全: 置換失敗時は必ず素通り（ゲームを壊さない）
- 低干渉: Harmony パッチ優先度を調整して他翻訳と競合しにくく
- 拡張性: フック対象の追加・削除が容易な構造（単一クラスに集約）

3) 主要コンポーネント
-------------------
- Config: INI 読み込み、入出力パス/閾値/モード設定
- NoiseFilter: ノイズ除外（数値のみ・URL・GUID・全角日本語のみ等）
- Normalizer: 表示前後で同一の正規化（タグ除去・改行/空白統一）
- TranslatorHub: 辞書ロード、置換、収集、出力（Per‑Mod 整理と集約）
- UIPatches: Harmony 前置パッチ群（UI描画直前で TranslateOrEnroll を呼ぶ）
- MenuUI: Mod設定パネル（ボタン/表示）
- （拡張）UTFBuilder: calls と辞書のJOINでUTF用XMLを子MODに出力

4) 設定（INI）
-------------
- ExportMode = TextOnly | Full | Both
- ExportRoot = %ModDir%/Export/                ; 収集ファイルのルート
- ExportPerMod = true                          ; MOD別にサブフォルダ出力
- EmitAggregate = true                         ; 集約版も自動生成
- DictPath = %ModDir%/Dict/strings_ja.tsv      ; 「英語<TAB>日本語」
- OverridesDir = %ModDir%/Dict/overrides       ; 同文異訳の例外TSVを入れるフォルダ（任意）
- MinLength = 2
- ExcludePatterns = （正規表現 | で連結）
- ApplyDictAtRuntime = true/false
- LogPath = %ModDir%/AutoUITranslator.log
- UTFOutRoot = %ModDir%/Build/UTF              ; （拡張）UTF XML出力先

5) ファイル入出力（標準）
----------------------
- 辞書: Dict/strings_ja.tsv
  - 形式: 英語<TAB>日本語（先頭2列のみ使用。3列目以降は無視）
  - 改行は /n で表記。句読点は日本語側は「。」で終幕推奨
- 収集（Per‑Mod 出力; ExportPerMod=true）:
  - Export/<ModName>/texts_en.txt … 英語のみ（見やすさ重視）
  - Export/<ModName>/strings_en.tsv … 4列（timestamp_utc, source, scope, text）
  - Export/<ModName>/calls_en.tsv … 6列（timestamp_utc, asmPath, modId, typeFullName, methodName, text）※拡張収集ON時
- 集約（EmitAggregate=true）:
  - Export/_All/texts_en_aggregate.txt … 全MODの英語をソート/重複排除して結合
  - Export/_All/untranslated.txt … 辞書に未収録の英語だけを一覧
- ログ: AutoUITranslator.log … 初期化、辞書件数、置換/収集ヒット件数、警告など
- （拡張）UTF子MOD:
  - Build/UTF/<ModName>/About/…
  - Build/UTF/<ModName>/Patches/AutoUITranslator.UTF.xml

6) 正規化（Normalizer）
--------------------
- 処理順: CRLF→LF → RichTextタグ除去（<color>/<size>/<b>/<i>/<u>/<br>/<align>） → 制御文字除去 → 改行→スペース → 連続スペース縮約 → Trim
- プレースホルダ: {0}, {1} 形式に統一（%d 等を正規化）
- 同一の Normalizer を「辞書ロード時」「収集時」「照合時」に共用すること

7) 置換ロジック
-------------
- 画面描画直前に文字列 `s` を受け取り、Normalize(s) をキーに辞書を検索
- 命中すれば日本語で上書き。未命中なら NoiseFilter を通過したものだけ収集に回す
- ApplyDictAtRuntime=false の場合は収集のみ（プレビュー無効）
- 例外訳（overrides）は「（type/method/ModName + 英語）」をキーとした優先辞書として適用

8) フック点（最低限 + 推奨追加）
------------------------------
【最低限】
- Widgets.Label(Rect, string)
- Listing_Standard.Label(string, float)
- TooltipHandler.TipRegion(Rect, TipSignal)
- Widgets.ButtonText(Rect, string, …)（プレビュー/任意）
【推奨追加】
- Widgets.HorizontalSlider / HorizontalSlider_NewTemp
- Widgets.FloatRange / Listing_Standard.Slider
- FloatMenuOption（右クリック）
- Command（Gizmo: defaultLabel/defaultDesc → GizmoOnGUI系）
- Dialog_Options / Dialog_MessageBox（ボタン）
- GUI.Label（フォールバック）

9) 収集と整理（Per‑Mod 出力）
--------------------------
- 収集時に呼び出し元の Assembly → Mod を特定し、現在の Mod セクションへ追記
- ExportPerMod=true のとき、MODごとにフォルダを分けて追記
- EmitAggregate=true のとき、保存時に全MODの英語をソート/重複排除して _All に再生成
- calls_en.tsv 収集を有効化すると、UTF連携で caller 情報（type/method）を吐く

10) Mod設定パネル（MenuUI）
--------------------------
- 表示項目:
  - 辞書ファイルのパス（参照/開く）・現在の登録件数
  - 直近収集件数（全体/本セッション）
  - ExportPerMod / EmitAggregate / ApplyDictAtRuntime のトグル
- ボタン:
  - 「辞書を再読み込み」… strings_ja.tsv を即時再読込
  - 「未訳一覧を生成」… Export/_All/untranslated.txt を生成
  - 「整理（MOD別/集約）を生成」… Per‑Mod の整形、_All 再生成
  - （拡張）「UTF XMLを生成」… calls_en.tsv + 辞書をJOINして子MOD出力
- 進行表示: 実行後に完了数/出力先を表示。重処理は try/catch で安全化

11) 競合と優先度
--------------
- Harmony パッチ優先度: 他翻訳系より「後」に実行して最終表示を握る
- 万一他MODが同じ箇所で別文字列にした場合でも、AutoUITranslator は辞書一致時のみ上書き（過剰置換を避ける）
- 置換できなかった場合は素通り（クラッシュ不可）

12) パフォーマンス
-----------------
- 辞書は起動時ロード、常駐。変更時は「辞書を再読み込み」で差分再構築
- 置換は1文字列あたり数μ秒～0.1ms 程度
- 大量UI画面でも実測負荷はごく小さい。問題が出た場合は ApplyDictAtRuntime を一時OFFで切り分け

13) テスト計画（抜粋）
-------------------
- 単体: Normalizer/NoiseFilter/辞書ヒット/未訳収集/Per‑Mod 出力/集約生成
- 結合: 各フック点での置換動作（ラベル/ツールチップ/ボタン/スライダー/ギズモ/右クリック）
- 回帰: 辞書再読み込みの反映、未訳の追加検出、同文異訳のオーバーライド
- 競合: 代表的翻訳MODと同時有効化での最終表示確認
- ストレス: 数万行辞書・大量UIの負荷計測

14) 将来拡張（任意）
------------------
- UTFBuilder を常設し、caller JOIN → UTF XML 子MOD生成をワンボタン化
- “場面ラベル”の自動タグ付（設定/ギズモ/右クリック等）で訳品質向上
- 簡易OCR（スクショ投下→文字列抽出→辞書候補生成）連携

15) 例: ファイルフォーマット
--------------------------
- strings_ja.tsv
  Enable anal drip graphics\t肛門ドリップ表示を有効化
  Enable vaginal drip graphics\t膣ドリップ表示を有効化
- strings_en.tsv（4列）
  2025-10-05T15:01:22Z\tUI\tWidgets.Label\tEnable anal drip graphics
- calls_en.tsv（6列）
  2025-10-05T15:01:22Z\tD:\\Steam\\...\\RJW.Menstruation.dll\tRJW.Menstruation\tRJW.Menstruation.SettingsWindow\tDoSettingsWindowContents\tEnable anal drip graphics

16) 既定値（推奨）
----------------
- ExportPerMod = true / EmitAggregate = true / ApplyDictAtRuntime = true
- MinLength = 2 / ExcludePatterns = 既定正規表現セット
- ExportRoot = %ModDir%/Export, DictPath = %ModDir%/Dict/strings_ja.tsv

17) 完成定義（DoD）
-----------------
- 主要UI経路（8)の最低限+推奨を網羅
- 辞書再読み込み／未訳一覧／整理（Per‑Mod+集約）がMod設定から操作可能
- Per‑Mod 出力と集約版が正しくソート・重複排除される
- ApplyDictAtRuntime=trueで全UIに即時反映、OFFで収集のみ
- クラッシュ/フリーズなし、ログに要点が残る

-- END OF SPEC --
